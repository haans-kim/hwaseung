# 근무시간 산출 로직 설명서

## 📊 개요
본 문서는 근무 이력 데이터로부터 각 직원별 월별 근무시간을 산출하는 로직을 설명합니다.

---

## 🗄️ 데이터 구조

### 원본 데이터 (Excel → SQLite)
- **파일**: 25년 06월/07월/08월 근무이력.xlsx
- **주요 필드**:
  - `user_id` (사번): 직원 고유 ID
  - `user_name` (성명): 직원 이름
  - `department` (소속팀): 부서명
  - `user_position` (직위): 직책
  - `work_date` (년월일): 근무 날짜
  - `weekday` (요일): 요일 정보
  - `항목`: 활동 유형 (출근, 퇴근, 시스템 ON/OFF, 화면 잠김 등)
  - `시작시각`: 활동 시작 시간
  - `종료시각`: 활동 종료 시간
  - `사용시간`: 해당 항목의 사용 시간(분)

### 항목 유형
```
- 시스템 ON/OFF: PC 켜기/끄기
- 출근/퇴근: 근태 시스템 출퇴근 기록
- 출근버튼 클릭/퇴근버튼 클릭: 수동 출퇴근 체크
- 화면 잠김 진입/해제: 화면 잠금 상태
- 초과: 초과 근무 기록
- 기본, 임시, 긴급: 기타 작업 유형
```

---

## ⏱️ 근무시간 계산 로직

### 1. 일별 근무시간 산출

#### 1.1 기본 계산 방식
```sql
-- 각 직원의 일별 첫 활동과 마지막 활동 시간 추출
첫 활동 시각 = MIN(시작시각) -- 해당일 가장 이른 활동
마지막 활동 시각 = MAX(종료시각 또는 시작시각) -- 해당일 가장 늦은 활동

일 근무시간(분) = (마지막 활동 시각 - 첫 활동 시각) × 24 × 60
```

#### 1.2 예외 처리
- **데이터 없는 경우**: 출근 기록만 있고 퇴근 기록이 없는 경우
  - 시스템 ON 또는 출근 기록이 있으면 → 기본 8시간(480분) 적용
  - 아무 기록도 없으면 → 0분

- **비정상 값 처리**:
  - 24시간 이상 → 24시간(1440분)으로 제한
  - 음수 값 → 0분으로 처리

#### 1.3 초과근무 시간
```sql
초과근무시간(분) = SUM(CASE WHEN 항목 = '초과' THEN 사용시간 ELSE 0 END)
```
- '초과' 항목으로 명시적으로 기록된 시간만 별도 집계
- 일반 근무시간과 구분하여 관리

### 2. 월별 집계

#### 2.1 집계 항목
```python
월별 집계 = GROUP BY (사번, 년, 월)
- 근무일수 = COUNT(DISTINCT work_date)
- 총근무시간(분) = SUM(일별 근무시간)
- 초과근무시간(분) = SUM(일별 초과근무시간)
- 주말근무일수 = COUNT(DISTINCT work_date WHERE 요일 IN ('토요일', '일요일'))
```

#### 2.2 파생 지표
```python
# 시간 단위 변환
총근무시간(시간) = 총근무시간(분) / 60

# 일평균 근무시간
일평균근무시간 = 총근무시간 / 근무일수

# 예상 정규 근무시간 (평일 8시간 기준)
예상정규근무시간 = (근무일수 - 주말근무일수) × 8

# 근무시간 차이 (실제 vs 예상)
근무시간차이 = 총근무시간 - 예상정규근무시간
```

---

## 📈 산출 예시

### 예시 1: 정상적인 근무 패턴
```
2025-06-02 (월요일) 김직원의 활동 로그:
- 08:30 시스템 ON
- 08:35 출근버튼 클릭
- 12:00 화면 잠김 진입 (점심시간)
- 13:00 화면 잠김 해제
- 18:00 퇴근버튼 클릭
- 18:05 시스템 OFF
- 19:00 초과 근무 시작
- 21:00 초과 근무 종료

산출 결과:
- 첫 활동: 08:30
- 마지막 활동: 21:00
- 일 근무시간: 12.5시간 (750분)
- 초과근무시간: 2시간 (120분)
```

### 예시 2: 불완전한 데이터
```
2025-06-03 (화요일) 박직원의 활동 로그:
- 09:00 출근버튼 클릭
- (퇴근 기록 없음)

산출 결과:
- 일 근무시간: 8시간 (480분) - 기본값 적용
- 초과근무시간: 0시간
```

---

## 🔍 데이터 검증

### 검증 기준
1. **근무시간 범위**: 0 ~ 24시간
2. **월 근무일수**: 최대 31일
3. **일평균 근무시간**: 합리적 범위 (4~16시간)

### 이상치 처리
- 24시간 이상 근무 → 24시간으로 제한
- 월 300시간 이상 → 검토 대상 표시
- 일평균 16시간 이상 → 검토 대상 표시

---

## 💾 출력 파일

### 1. daily_work_hours.csv
- 일별 상세 근무시간 데이터
- 각 직원의 일별 출퇴근 시간 및 근무시간

### 2. monthly_work_hours.csv
- 월별 집계 데이터
- 컬럼 구성:
  ```
  사번, 성명, 소속팀, 직위, 년, 월,
  근무일수, 총근무시간_분, 초과근무시간_분, 주말근무일수,
  총근무시간, 초과근무시간, 일평균근무시간,
  예상정규근무시간, 근무시간차이
  ```

### 3. work_hours_analysis.xlsx
- Excel 분석 파일
- 시트 구성:
  - 월별집계: 개인별 월별 상세 데이터
  - 부서별평균: 부서별 평균 근무시간

---

## 📝 주의사항

1. **데이터 품질**
   - 출퇴근 기록이 누락된 경우 기본값(8시간) 적용
   - 시스템 ON/OFF 기록을 보조 지표로 활용

2. **초과근무 계산**
   - '초과' 항목으로 명시된 시간만 초과근무로 집계
   - 정규 근무시간 초과분과 별도 관리

3. **주말 근무**
   - 토요일, 일요일 근무는 별도 카운트
   - 주말 근무시간도 총 근무시간에 포함

4. **한계점**
   - 재택근무, 외근 등은 시스템 로그에 반영되지 않을 수 있음
   - 점심시간 등 휴게시간이 근무시간에 포함될 수 있음

---

## 🛠️ 관련 스크립트

- `import_to_sqlite.py`: Excel 데이터를 SQLite로 임포트
- `calculate_work_hours.py`: 근무시간 계산 및 집계
- `analyze_work_data.py`: 데이터 분석 및 통계 생성

---

*작성일: 2025년 9월*
*버전: 1.0*